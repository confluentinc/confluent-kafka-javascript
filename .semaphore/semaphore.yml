# This file is managed by ServiceBot plugin - Semaphore. The content in this file is created using a common
# template and configurations in service.yml.
# Any modifications made to version, name, agent, and global_job_config will be overwritten by the generated
# content in nightly runs. Code changes made to the remaining sections will not be affected.
# For more information, please refer to the page:
# https://confluentinc.atlassian.net/wiki/spaces/Foundations/pages/2871296194/Add+SemaphoreCI
version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

auto_cancel:
  running:
    when: "branch != 'master'"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'master'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout

blocks:
  # - name: "Linux amd64"
  #   dependencies: [ ]
  #   task:
  #     agent:
  #       machine:
  #         type: s1-prod-ubuntu20-04-amd64-2
  #     prologue:
  #       commands:
  #         - sem-version node 18.19.0
  #         - node --version
  #         - npm --version
  #         - npx --version
  #         - sudo apt-get update -q
  #         - git submodule update --init --recursive
  #     jobs:
  #       - name: "Build from source and test"
  #         commands:
  #           - sudo apt install -y  libcurl4-openssl-dev libcrypto++-dev libssl-dev libzstd-dev
  #           - npm install # this will actually not build anything if we have a release, but rather, fetch things using node-pre-gyp - so change this later.
  #           - make test
  #       - name: "ESLint"
  #         commands:
  #           - npm install --only=dev
  #           - npx eslint lib/kafkajs

  - name: 'OSX arm64/m1'
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos-arm64
      prologue:
        commands:
          - sem-version node 18.19.0
          - node --version
          - npm --version
          - npx --version
          - git submodule update --init --recursive
      jobs:
        - name: 'Build from source and test'
          commands:
            - npm install # this will actually not build anything if we have a release, but rather, fetch things using node-pre-gyp - so change this later.
            - make test


